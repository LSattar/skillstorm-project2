<app-header
  [isNavOpen]="isNavOpen"
  [isAuthenticated]="isAuthenticated"
  [roleLabel]="roleLabel"
  [userLabel]="userLabel"
  [userEmail]="userEmail"
  [showSystemSettings]="auth.isAdmin()"
  (toggleNav)="toggleNav()"
  (closeNav)="closeNav()"
  (openBooking)="openBooking()"
  (openSignIn)="openSignIn()"
  (logout)="signOut()"
  (openProfile)="openProfile()"
></app-header>

<main>
  <div class="container">
    <div class="page-content payment-transactions-page">
      <div class="page-header">
        <h1>Payment Transactions</h1>
        <p class="subtitle">View and manage hotel booking payments.</p>
      </div>

      <!-- KPI Cards -->
      <section class="summary-section" aria-label="KPI Filters">
        <div class="summary-grid">
          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'ALL'"
            aria-pressed="{{ activeKpi === 'ALL' }}"
            (click)="onKpiClick('ALL')"
          >
            <h3>Total Revenue</h3>
            <p class="summary-value">{{ formatCurrency(summaryRevenue) }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'SUCCEEDED'"
            aria-pressed="{{ activeKpi === 'SUCCEEDED' }}"
            (click)="onKpiClick('SUCCEEDED')"
          >
            <h3>Paid</h3>
            <p class="summary-value">{{ paidCount }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'PROCESSING'"
            aria-pressed="{{ activeKpi === 'PROCESSING' }}"
            (click)="onKpiClick('PROCESSING')"
          >
            <h3>Pending</h3>
            <p class="summary-value">{{ pendingCount }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'FAILED'"
            aria-pressed="{{ activeKpi === 'FAILED' }}"
            (click)="onKpiClick('FAILED')"
          >
            <h3>Failed</h3>
            <p class="summary-value">{{ failedCount }}</p>
          </button>
        </div>
      </section>

      <!-- Filters/Search -->
      <section class="search-section">
        <form class="search-form" (ngSubmit)="onSearch()">
          <div class="form-row">
            <div class="form-group">
              <label for="searchQuery">Search</label>
              <input class="input" type="text" id="searchQuery" [(ngModel)]="query" name="query" />
            </div>

            <div class="form-group">
              <label for="searchStatus">Status</label>
              <select id="searchStatus" [(ngModel)]="status" name="status" class="input">
                <option value="">All Statuses</option>
                <option value="SUCCEEDED">Paid</option>
                <option value="PROCESSING">Pending</option>
                <option value="FAILED">Failed</option>
                <option value="REFUNDED">Refunded</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>

            <div class="form-group">
              <label for="fromDate">From</label>
              <input
                class="input"
                type="date"
                id="fromDate"
                [(ngModel)]="fromDate"
                name="fromDate"
              />
            </div>

            <div class="form-group">
              <label for="toDate">To</label>
              <input class="input" type="date" id="toDate" [(ngModel)]="toDate" name="toDate" />
            </div>
          </div>

          <div class="form-actions search-actions">
            <button type="submit" class="btn btn-primary">Search</button>
            <button type="button" class="btn btn-secondary" (click)="onClearFilters()">
              Clear
            </button>
          </div>
        </form>
      </section>

      <!-- Table -->
      <section class="results-section">
        <div class="results-header">
          <h2>Transactions</h2>
          <span class="result-count">{{ transactions.length }} found</span>
        </div>

        <div class="transactions-table">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Guest</th>
                <th>Reservation</th>
                <th>Nights</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let tx of transactions; trackBy: trackById">
                <td>{{ formatDate(tx.createdAt) }}</td>
                <td>{{ tx.guestName }}</td>
                <td>{{ tx.reservationId }}</td>
                <td>{{ computeNights(tx.checkIn, tx.checkOut) }}</td>
                <td>{{ formatCurrency(tx.amount, tx.currency) }}</td>
                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(tx.status)">
                    {{ tx.status }}
                  </span>
                </td>
                <td>{{ tx.provider }}</td>
                <td>
                  <button class="btn btn-sm btn-primary" (click)="openDetailsModal(tx)">
                    View details
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Pagination -->
      <div class="pagination" *ngIf="total > size">
        <button class="btn btn-link" [disabled]="page === 0" (click)="onPageChange(page - 1)">
          Prev
        </button>
        <span>Page {{ page + 1 }}</span>
        <button
          class="btn btn-link"
          [disabled]="(page + 1) * size >= total"
          (click)="onPageChange(page + 1)"
        >
          Next
        </button>
      </div>

      <!-- Generate Report (BOTTOM — KEEP THIS) -->
      <section class="report-footer-cta">
        <div class="report-footer-card">
          <div>
            <h2>Annual Payment Report</h2>
            <p>Download a detailed report of payment transactions for the past 12 months.</p>
          </div>

          <button
            type="button"
            class="btn btn-accent"
            [disabled]="reportLoading"
            (click)="downloadAnnualPaymentReport()"
          >
            {{ reportLoading ? 'Generating…' : 'Generate Report' }}
          </button>

          <p class="report-hint" *ngIf="reportError">{{ reportError }}</p>
        </div>
      </section>
    </div>
  </div>
</main>
