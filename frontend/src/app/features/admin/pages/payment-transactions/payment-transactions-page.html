<app-header
  [isNavOpen]="isNavOpen"
  [isAuthenticated]="isAuthenticated"
  [roleLabel]="roleLabel"
  [userLabel]="userLabel"
  [userEmail]="userEmail"
  [showSystemSettings]="auth.isAdmin()"
  (toggleNav)="toggleNav()"
  (closeNav)="closeNav()"
  (openBooking)="openBooking()"
  (openSignIn)="openSignIn()"
  (logout)="signOut()"
  (openProfile)="openProfile()"
></app-header>

<main>
  <div class="container">
    <div class="page-content payment-transactions-page">
      <div class="page-header">
        <h1>Payment Transactions</h1>
        <p class="subtitle">View and manage hotel booking payments.</p>
      </div>

      <!-- KPI Cards -->
      <section class="summary-section" aria-label="KPI Filters">
        <div class="summary-grid">
          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'ALL'"
            aria-pressed="{{ activeKpi === 'ALL' }}"
            (click)="onKpiClick('ALL')"
            tabindex="0"
          >
            <h3>Total Revenue</h3>
            <p class="summary-value">{{ formatCurrency(summaryRevenue) }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'SUCCEEDED'"
            aria-pressed="{{ activeKpi === 'SUCCEEDED' }}"
            (click)="onKpiClick('SUCCEEDED')"
            tabindex="0"
          >
            <h3>Paid</h3>
            <p class="summary-value">{{ paidCount }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'PROCESSING'"
            aria-pressed="{{ activeKpi === 'PROCESSING' }}"
            (click)="onKpiClick('PROCESSING')"
            tabindex="0"
          >
            <h3>Pending</h3>
            <p class="summary-value">{{ pendingCount }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'FAILED'"
            aria-pressed="{{ activeKpi === 'FAILED' }}"
            (click)="onKpiClick('FAILED')"
            tabindex="0"
          >
            <h3>Failed</h3>
            <p class="summary-value">{{ failedCount }}</p>
          </button>
        </div>
      </section>

      <!-- Filters/Search -->
      <section class="search-section">
        <form class="search-form" (ngSubmit)="onSearch()">
          <div class="form-row">
            <div class="form-group">
              <label for="searchQuery">Search</label>
              <input
                class="input"
                type="text"
                id="searchQuery"
                [(ngModel)]="query"
                name="query"
                placeholder="Search by guest, reservation, transaction…"
              />
            </div>

            <div class="form-group">
              <label for="searchStatus">Status</label>
              <select id="searchStatus" [(ngModel)]="status" name="status" class="input">
                <option value="">All Statuses</option>
                <option value="SUCCEEDED">Paid</option>
                <option value="PROCESSING">Pending</option>
                <option value="FAILED">Failed</option>
                <option value="REFUNDED">Refunded</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>

            <div class="form-group">
              <label for="fromDate">From</label>
              <input
                class="input"
                type="date"
                id="fromDate"
                [(ngModel)]="fromDate"
                name="fromDate"
              />
            </div>

            <div class="form-group">
              <label for="toDate">To</label>
              <input class="input" type="date" id="toDate" [(ngModel)]="toDate" name="toDate" />
            </div>
          </div>

          <div class="date-presets" role="group" aria-label="Quick date presets">
            <button type="button" class="btn btn-link date-preset" (click)="setDatePreset('today')">
              Today
            </button>
            <button type="button" class="btn btn-link date-preset" (click)="setDatePreset('last7')">
              Last 7 days
            </button>
            <button
              type="button"
              class="btn btn-link date-preset"
              (click)="setDatePreset('last30')"
            >
              Last 30 days
            </button>
            <button type="button" class="btn btn-link date-preset" (click)="setDatePreset('month')">
              This month
            </button>
            <button type="button" class="btn btn-link date-preset" (click)="onClearFilters()">
              Clear
            </button>
          </div>

          <div class="form-actions search-actions">
            <button type="submit" class="btn btn-primary">
              <span class="material-symbols-outlined">search</span>
              Search
            </button>
            <button type="button" class="btn btn-secondary" (click)="onClearFilters()">
              <span class="material-symbols-outlined">clear</span>
              Clear
            </button>
          </div>
        </form>
      </section>

      <!-- Table -->
      <section class="results-section">
        <div class="results-header">
          <h2>Transactions</h2>
          <span class="result-count">{{ transactions.length }} found</span>
        </div>

        <div class="transactions-table">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Guest</th>
                <th>Reservation</th>
                <th>Nights</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <!-- Skeleton loading rows -->
              <ng-container *ngIf="loading">
                <tr *ngFor="let i of skeletonRows">
                  <td colspan="8">
                    <div class="skeleton-row" [class.stopped]="skeletonStopped"></div>
                  </td>
                </tr>
              </ng-container>

              <!-- Empty state -->
              <tr *ngIf="!loading && transactions.length === 0 && !error">
                <td colspan="8">
                  <div class="empty-state">
                    <span class="material-symbols-outlined">search_off</span>
                    <p *ngIf="!fromDate && !toDate && !query && !status">
                      No payment transactions yet. Payments will appear here after guests complete
                      bookings.
                    </p>
                    <ng-container *ngIf="fromDate || toDate || query || status">
                      No transactions match your filters.
                      <button class="btn btn-link" (click)="onClearFilters()">Clear filters</button>
                    </ng-container>
                  </div>
                </td>
              </tr>

              <!-- Data rows -->
              <tr *ngFor="let tx of transactions; trackBy: trackById" [attr.tabindex]="0">
                <td>{{ formatDate(tx.createdAt) || '—' }}</td>

                <td>
                  <span class="guest-name">{{ tx.guestName || '—' }}</span
                  ><br />
                  <span class="guest-email">{{ tx.guestEmail || '—' }}</span>
                </td>

                <td>
                  <span class="reservation-id">{{ tx.reservationId || '—' }}</span
                  ><br />
                  <span>
                    {{ formatDate(tx.checkIn) || '—' }} - {{ formatDate(tx.checkOut) || '—' }}
                  </span>
                </td>

                <td>{{ computeNights(tx.checkIn, tx.checkOut) || '—' }}</td>

                <td>{{ formatCurrency(tx.amount, tx.currency) || '—' }}</td>

                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(tx.status)">
                    {{ tx.status || '—' }}
                  </span>
                </td>

                <td>
                  <span>{{ tx.provider || '—' }}</span>
                  <span *ngIf="tx.paymentMethodLast4">•••• {{ tx.paymentMethodLast4 }}</span>
                  <span *ngIf="!tx.paymentMethodLast4 && tx.transactionId" class="reservation-id">
                    <br />Ref: {{ tx.transactionId }}
                  </span>
                </td>

                <td>
                  <button class="btn btn-sm btn-primary" (click)="openDetailsModal(tx)">
                    <span class="material-symbols-outlined">visibility</span>
                    View details
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="error" class="error-state">
          <p>{{ error }}</p>
          <button class="btn btn-primary" (click)="retryLoadTransactions()">Retry</button>
        </div>
      </section>

      <!-- Pagination (simple) -->
      <div class="pagination" *ngIf="total > size">
        <button class="btn btn-link" [disabled]="page === 0" (click)="onPageChange(page - 1)">
          Prev
        </button>
        <span>Page {{ page + 1 }}</span>
        <button
          class="btn btn-link"
          [disabled]="(page + 1) * size >= total"
          (click)="onPageChange(page + 1)"
        >
          Next
        </button>
      </div>

      <!-- Generate Report (BOTTOM, just above footer) -->
      <section class="report-footer-cta" aria-label="Reports">
        <div class="report-footer-card">
          <div class="report-footer-text">
            <h2>Annual Payment Report</h2>
            <p>
              Download a detailed report of payment transactions for the past 12 months, including
              guest, reservation, status, and totals.
            </p>
          </div>

          <div class="report-footer-actions">
            <button
              type="button"
              class="btn btn-accent"
              [disabled]="reportLoading"
              (click)="downloadAnnualPaymentReport()"
            >
              <span class="material-symbols-outlined">download</span>
              {{ reportLoading ? 'Generating…' : 'Generate Report' }}
            </button>

            <p class="report-hint" *ngIf="reportError">{{ reportError }}</p>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>

<main>
  <div class="container">
    <div class="page-content payment-transactions-page">
      <div class="page-header">
        <h1>Payment Transactions</h1>
        <p class="subtitle">View and manage hotel booking payments.</p>
      </div>

      <!-- KPI Cards -->
      <section class="summary-section" aria-label="KPI Filters">
        <div class="summary-grid">
          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'ALL'"
            aria-pressed="{{ activeKpi === 'ALL' }}"
            (click)="onKpiClick('ALL')"
            tabindex="0"
          >
            <h3>Total Revenue</h3>
            <p class="summary-value">{{ formatCurrency(summaryRevenue) }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'SUCCEEDED'"
            aria-pressed="{{ activeKpi === 'SUCCEEDED' }}"
            (click)="onKpiClick('SUCCEEDED')"
            tabindex="0"
          >
            <h3>Paid</h3>
            <p class="summary-value">{{ paidCount }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'PROCESSING'"
            aria-pressed="{{ activeKpi === 'PROCESSING' }}"
            (click)="onKpiClick('PROCESSING')"
            tabindex="0"
          >
            <h3>Pending</h3>
            <p class="summary-value">{{ pendingCount }}</p>
          </button>

          <button
            type="button"
            class="summary-card kpi-card"
            [class.active]="activeKpi === 'FAILED'"
            aria-pressed="{{ activeKpi === 'FAILED' }}"
            (click)="onKpiClick('FAILED')"
            tabindex="0"
          >
            <h3>Failed</h3>
            <p class="summary-value">{{ failedCount }}</p>
          </button>
        </div>
      </section>

      <!-- Filters/Search -->
      <section class="search-section">
        <form class="search-form" (ngSubmit)="onSearch()">
          <div class="form-row">
            <div class="form-group">
              <label for="searchQuery">Search</label>
              <input
                class="input"
                type="text"
                id="searchQuery"
                [(ngModel)]="query"
                name="query"
                placeholder="Search by guest, reservation, transaction…"
              />
            </div>

            <div class="form-group">
              <label for="searchStatus">Status</label>
              <select id="searchStatus" [(ngModel)]="status" name="status" class="input">
                <option value="">All Statuses</option>
                <option value="SUCCEEDED">Paid</option>
                <option value="PROCESSING">Pending</option>
                <option value="FAILED">Failed</option>
                <option value="REFUNDED">Refunded</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>

            <div class="form-group">
              <label for="fromDate">From</label>
              <input
                class="input"
                type="date"
                id="fromDate"
                [(ngModel)]="fromDate"
                name="fromDate"
              />
            </div>

            <div class="form-group">
              <label for="toDate">To</label>
              <input class="input" type="date" id="toDate" [(ngModel)]="toDate" name="toDate" />
            </div>
          </div>

          <div class="date-presets" role="group" aria-label="Quick date presets">
            <button type="button" class="btn btn-link date-preset" (click)="setDatePreset('today')">
              Today
            </button>
            <button type="button" class="btn btn-link date-preset" (click)="setDatePreset('last7')">
              Last 7 days
            </button>
            <button
              type="button"
              class="btn btn-link date-preset"
              (click)="setDatePreset('last30')"
            >
              Last 30 days
            </button>
            <button type="button" class="btn btn-link date-preset" (click)="setDatePreset('month')">
              This month
            </button>
            <button type="button" class="btn btn-link date-preset" (click)="onClearFilters()">
              Clear
            </button>
          </div>

          <div class="form-actions search-actions">
            <button type="submit" class="btn btn-primary">
              <span class="material-symbols-outlined">search</span>
              Search
            </button>
            <button type="button" class="btn btn-secondary" (click)="onClearFilters()">
              <span class="material-symbols-outlined">clear</span>
              Clear
            </button>
          </div>
        </form>
      </section>

      <!-- Table -->
      <section class="results-section">
        <div class="results-header">
          <h2>Transactions</h2>
          <span class="result-count">{{ transactions.length }} found</span>
        </div>

        <div class="transactions-table">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Guest</th>
                <th>Reservation</th>
                <th>Nights</th>
                <th>Total</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <!-- Skeleton loading rows -->
              <ng-container *ngIf="loading">
                <tr *ngFor="let i of skeletonRows">
                  <td colspan="8">
                    <div class="skeleton-row" [class.stopped]="skeletonStopped"></div>
                  </td>
                </tr>
              </ng-container>

              <!-- Empty state -->
              <tr *ngIf="!loading && transactions.length === 0 && !error">
                <td colspan="8">
                  <div class="empty-state">
                    <span class="material-symbols-outlined">search_off</span>
                    <p *ngIf="!fromDate && !toDate && !query && !status">
                      No payment transactions yet. Payments will appear here after guests complete
                      bookings.
                    </p>
                    <ng-container *ngIf="fromDate || toDate || query || status">
                      No transactions match your filters.
                      <button class="btn btn-link" (click)="onClearFilters()">Clear filters</button>
                    </ng-container>
                  </div>
                </td>
              </tr>

              <!-- Data rows -->
              <tr *ngFor="let tx of transactions; trackBy: trackById" [attr.tabindex]="0">
                <td>{{ formatDate(tx.createdAt) || '—' }}</td>

                <td>
                  <span class="guest-name">{{ tx.guestName || '—' }}</span
                  ><br />
                  <span class="guest-email">{{ tx.guestEmail || '—' }}</span>
                </td>

                <td>
                  <span class="reservation-id">{{ tx.reservationId || '—' }}</span
                  ><br />
                  <span>
                    {{ formatDate(tx.checkIn) || '—' }} - {{ formatDate(tx.checkOut) || '—' }}
                  </span>
                </td>

                <td>{{ computeNights(tx.checkIn, tx.checkOut) || '—' }}</td>

                <td>{{ formatCurrency(tx.amount, tx.currency) || '—' }}</td>

                <td>
                  <span class="status-badge" [ngClass]="getStatusClass(tx.status)">
                    {{ tx.status || '—' }}
                  </span>
                </td>

                <td>
                  <span>{{ tx.provider || '—' }}</span>
                  <span *ngIf="tx.paymentMethodLast4">•••• {{ tx.paymentMethodLast4 }}</span>
                  <span *ngIf="!tx.paymentMethodLast4 && tx.transactionId" class="reservation-id">
                    <br />Ref: {{ tx.transactionId }}
                  </span>
                </td>

                <td>
                  <button class="btn btn-sm btn-primary" (click)="openDetailsModal(tx)">
                    <span class="material-symbols-outlined">visibility</span>
                    View details
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="error" class="error-state">
          <p>{{ error }}</p>
          <button class="btn btn-primary" (click)="retryLoadTransactions()">Retry</button>
        </div>
      </section>

      <!-- Pagination (simple) -->
      <div class="pagination" *ngIf="total > size">
        <button class="btn btn-link" [disabled]="page === 0" (click)="onPageChange(page - 1)">
          Prev
        </button>
        <span>Page {{ page + 1 }}</span>
        <button
          class="btn btn-link"
          [disabled]="(page + 1) * size >= total"
          (click)="onPageChange(page + 1)"
        >
          Next
        </button>
      </div>

      <!-- Generate Report (BOTTOM, just above footer) -->
      <section class="report-footer-cta" aria-label="Reports">
        <div class="report-footer-card">
          <div class="report-footer-text">
            <h2>Annual Payment Report</h2>
            <p>
              Download a detailed report of payment transactions for the past 12 months, including
              guest, reservation, status, and totals.
            </p>
          </div>

          <div class="report-footer-actions">
            <button
              type="button"
              class="btn btn-accent"
              [disabled]="reportLoading"
              (click)="downloadAnnualPaymentReport()"
            >
              <span class="material-symbols-outlined">download</span>
              {{ reportLoading ? 'Generating…' : 'Generate Report' }}
            </button>

            <p class="report-hint" *ngIf="reportError">{{ reportError }}</p>
          </div>
        </div>
      </section>
    </div>
  </div>
</main>
