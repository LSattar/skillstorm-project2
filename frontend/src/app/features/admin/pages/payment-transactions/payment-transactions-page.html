<app-header
  [isNavOpen]="isNavOpen"
  [isAuthenticated]="isAuthenticated"
  [roleLabel]="roleLabel"
  [userLabel]="userLabel"
  [userEmail]="userEmail"
  (toggleNav)="toggleNav()"
  (closeNav)="closeNav()"
  (openBooking)="openBooking()"
  (openSignIn)="openSignIn()"
  (logout)="signOut()"
  (openProfile)="openProfile()"
></app-header>

<main>
  <div class="payment-transactions-page">
    <div class="page-header">
      <h1>Payment Transactions</h1>
      <p class="subtitle">View and manage hotel booking payments.</p>
    </div>

    <!-- Summary Cards -->
    <section class="summary-section">
      <div class="summary-grid">
        <div class="summary-card">
          <h3>Total Revenue</h3>
          <p class="summary-value">{{ formatCurrency(summaryRevenue) }}</p>
        </div>
        <div class="summary-card">
          <h3>Paid</h3>
          <p class="summary-value">{{ paidCount }}</p>
        </div>
        <div class="summary-card">
          <h3>Pending</h3>
          <p class="summary-value">{{ pendingCount }}</p>
        </div>
        <div class="summary-card">
          <h3>Failed</h3>
          <p class="summary-value">{{ failedCount }}</p>
        </div>
      </div>
    </section>

    <!-- Filters/Search -->
    <section class="search-section">
      <form class="search-form" (ngSubmit)="onSearch()">
        <div class="form-row">
          <div class="form-group">
            <label for="searchQuery">Search</label>
            <input
              class="input"
              type="text"
              id="searchQuery"
              [(ngModel)]="query"
              name="query"
              placeholder="Search by guest, reservation, transaction…"
            />
          </div>
          <div class="form-group">
            <label for="searchStatus">Status</label>
            <select id="searchStatus" [(ngModel)]="status" name="status" class="input">
              <option value="">All Statuses</option>
              <option value="PAID">Paid</option>
              <option value="PENDING">Pending</option>
              <option value="FAILED">Failed</option>
              <option value="REFUNDED">Refunded</option>
            </select>
          </div>
          <div class="form-group">
            <label for="fromDate">From</label>
            <input class="input" type="date" id="fromDate" [(ngModel)]="fromDate" name="fromDate" />
          </div>
          <div class="form-group">
            <label for="toDate">To</label>
            <input class="input" type="date" id="toDate" [(ngModel)]="toDate" name="toDate" />
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <span class="material-symbols-outlined">search</span>
            Search
          </button>
          <button type="button" class="btn btn-secondary" (click)="onClearFilters()">
            <span class="material-symbols-outlined">clear</span>
            Clear
          </button>
        </div>
      </form>
    </section>

    <!-- Table -->
    <section class="results-section">
      <div class="results-header">
        <h2>Transactions</h2>
        <span class="result-count">{{ transactions.length }} found</span>
      </div>

      <ng-container *ngIf="loading; else notLoading">
        <div class="loading-state">
          <p>Loading transactions...</p>
        </div>
      </ng-container>
      <ng-template #notLoading>
        <ng-container *ngIf="error; else noError">
          <div class="error-state">
            <p>{{ error }}</p>
            <button class="btn btn-primary" (click)="loadTransactions()">Retry</button>
          </div>
        </ng-container>
        <ng-template #noError>
          <ng-container *ngIf="transactions.length === 0; else hasResults">
            <div class="empty-state">
              <span class="material-symbols-outlined">search_off</span>
              <p>No payment transactions found.</p>
            </div>
          </ng-container>
          <ng-template #hasResults>
            <div class="transactions-table">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Guest</th>
                    <th>Reservation</th>
                    <th>Nights</th>
                    <th>Subtotal</th>
                    <th>Tax</th>
                    <th>Discounts/Rewards</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Payment Method</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let tx of transactions; trackBy: trackById">
                    <td>{{ formatDate(tx.createdAt) }}</td>
                    <td>
                      <span class="guest-name">{{ tx.guestName }}</span>
                      <br />
                      <span class="guest-email">{{ tx.guestEmail }}</span>
                    </td>
                    <td>
                      <span class="reservation-id">{{ tx.reservationId }}</span>
                      <br />
                      <!-- Room type not available in PaymentTransaction; remove or replace if needed -->
                      <br />
                      <span>{{ formatDate(tx.checkIn) }} - {{ formatDate(tx.checkOut) }}</span>
                    </td>
                    <td>{{ computeNights(tx.checkIn, tx.checkOut) }}</td>
                    <td>{{ formatCurrency(tx.subtotal, tx.currency) }}</td>
                    <td>{{ formatCurrency(tx.taxTotal, tx.currency) }}</td>
                    <td>
                      <span *ngIf="tx.discountTotal">{{
                        formatCurrency(tx.discountTotal, tx.currency)
                      }}</span>
                      <span *ngIf="tx.rewardsEarned"
                        >+{{ formatCurrency(tx.rewardsEarned, tx.currency) }}</span
                      >
                    </td>
                    <td>{{ formatCurrency(tx.total, tx.currency) }}</td>
                    <td>
                      <span class="status-badge" [ngClass]="getStatusClass(tx.status)">
                        {{ tx.status }}
                      </span>
                    </td>
                    <td>
                      <span>{{ tx.paymentProvider }}</span>
                      <span *ngIf="tx.paymentMethodLast4">•••• {{ tx.paymentMethodLast4 }}</span>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-primary" (click)="openDetailsModal(tx)">
                        <span class="material-symbols-outlined">visibility</span>
                        View details
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-template>
        </ng-template>
      </ng-template>
    </section>

    <!-- Pagination (simple) -->
    <div class="pagination" *ngIf="total > size">
      <button class="btn btn-link" [disabled]="page === 0" (click)="onPageChange(page - 1)">
        Prev
      </button>
      <span>Page {{ page + 1 }}</span>
      <button
        class="btn btn-link"
        [disabled]="(page + 1) * size >= total"
        (click)="onPageChange(page + 1)"
      >
        Next
      </button>
    </div>
  </div>

  <!-- Details Modal -->
  <app-user-profile-modal
    *ngIf="showDetailsModal && selected"
    [open]="showDetailsModal"
    (closed)="closeDetailsModal()"
  >
    <!-- You can replace this with a custom modal if needed -->
    <div class="modal-content">
      <h2>Transaction Details</h2>
      <p><strong>Guest:</strong> {{ selected.guestName }} ({{ selected.guestEmail }})</p>
      <p><strong>Reservation:</strong> {{ selected.reservationId }}</p>
      <!-- Room type not available in PaymentTransaction; remove or replace if needed -->
      <p><strong>Check-in:</strong> {{ formatDate(selected.checkIn) }}</p>
      <p><strong>Check-out:</strong> {{ formatDate(selected.checkOut) }}</p>
      <p><strong>Nights:</strong> {{ computeNights(selected.checkIn, selected.checkOut) }}</p>
      <p>
        <strong>Nightly Rate:</strong>
        {{ formatCurrency(selected.nightlyRate || 0, selected.currency) }}
      </p>
      <p><strong>Subtotal:</strong> {{ formatCurrency(selected.subtotal, selected.currency) }}</p>
      <p><strong>Tax:</strong> {{ formatCurrency(selected.taxTotal, selected.currency) }}</p>
      <div *ngIf="selected.taxLineItems?.length">
        <strong>Tax Items:</strong>
        <ul>
          <li *ngFor="let item of selected.taxLineItems">
            {{ item.label }}: {{ formatCurrency(item.amount, selected.currency) }}
          </li>
        </ul>
      </div>
      <p *ngIf="selected.feesTotal">
        <strong>Fees:</strong> {{ formatCurrency(selected.feesTotal, selected.currency) }}
      </p>
      <div *ngIf="selected.discountLineItems?.length">
        <strong>Discounts:</strong>
        <ul>
          <li *ngFor="let item of selected.discountLineItems">
            {{ item.label }}: -{{ formatCurrency(item.amount, selected.currency) }}
          </li>
        </ul>
      </div>
      <p *ngIf="selected.rewardsEarned">
        <strong>Rewards Earned:</strong>
        {{ formatCurrency(selected.rewardsEarned, selected.currency) }}
      </p>
      <p *ngIf="selected.rewardsApplied">
        <strong>Rewards Applied:</strong> -{{
          formatCurrency(selected.rewardsApplied, selected.currency)
        }}
      </p>
      <p><strong>Total:</strong> {{ formatCurrency(selected.total, selected.currency) }}</p>
      <p>
        <strong>Status:</strong>
        <span class="status-badge" [ngClass]="getStatusClass(selected.status)">{{
          selected.status
        }}</span>
      </p>
      <p><strong>Payment Provider:</strong> {{ selected.paymentProvider }}</p>
      <p *ngIf="selected.paymentMethodLast4">
        <strong>Card Last 4:</strong> {{ selected.paymentMethodLast4 }}
      </p>
      <p><strong>Transaction ID:</strong> {{ selected.transactionId }}</p>
      <p><strong>Created:</strong> {{ formatDate(selected.createdAt) }}</p>
      <p><strong>Updated:</strong> {{ formatDate(selected.updatedAt) }}</p>
    </div>
  </app-user-profile-modal>

  <app-footer [year]="today.getFullYear()"></app-footer>
</main>
