<app-header
  [isNavOpen]="isNavOpen"
  [isAuthenticated]="isAuthenticated()"
  [roleLabel]="roleLabel()"
  [userLabel]="userLabel()"
  [userEmail]="userEmail()"
  [showSystemSettings]="auth.isAdmin()"
  (toggleNav)="toggleNav()"
  (closeNav)="closeNav()"
  (openBooking)="openBooking()"
  (openSignIn)="openSignIn()"
  (logout)="signOut()"
  (openProfile)="openProfile()"
  (openSystemSettings)="openSystemSettings()"
></app-header>

<main>
  <div class="guest-dashboard">
    <div class="dashboard-header">
      <h1>My Bookings</h1>
      <p>Welcome! View and manage your reservations, check in, and review your balances</p>
    </div>

    @if (loading) {
    <div class="loading-state">
      <p>Loading your bookings...</p>
    </div>
    } @else { @if (error) {
    <div class="error-state">
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="loadReservations()">Retry</button>
    </div>
    } @else {
    <!-- Summary Cards -->
    <section class="summary-section">
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-icon">
            <span class="material-symbols-outlined">hotel</span>
          </div>
          <div class="summary-content">
            <h3>Total Stays</h3>
            <p class="summary-value">{{ getTotalStays() }}</p>
            <span class="summary-subtext">All-time reservations</span>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-icon">
            <span class="material-symbols-outlined">account_balance_wallet</span>
          </div>
          <div class="summary-content">
            <h3>Total Balance</h3>
            <p class="summary-value">{{ formatCurrency(calculateTotalBalance()) }}</p>
            <span class="summary-subtext">Active reservations</span>
          </div>
        </div>

        <div class="summary-card">
          <div class="summary-icon">
            <span class="material-symbols-outlined">stars</span>
          </div>
          <div class="summary-content">
            <h3>Rewards Points</h3>
            <p class="summary-value">{{ getTotalRewardsPoints() }}</p>
            <span class="summary-subtext">Available points</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Reservations List -->
    <section class="reservations-section">
      <h2>Your Reservations</h2>

      @if (reservations.length === 0) {
      <div class="empty-state">
        <p>You don't have any reservations yet.</p>
        <button class="btn btn-primary" (click)="openBooking()">Search for Rooms</button>
      </div>
      } @else {
      <div class="reservations-list">
        @for (reservation of reservations; track reservation.reservationId) {
        <div class="reservation-card">
          <div class="reservation-header">
            <div class="reservation-title">
              <h3 class="stay-title">Stay at {{ getHotelLocation(reservation.hotelId) }}</h3>
              <p class="stay-dates">
                {{ formatDate(reservation.startDate) }} - {{ formatDate(reservation.endDate) }}
              </p>
            </div>
            <span class="status-badge {{ getStatusClass(reservation.status) }}">
              {{ getStatusLabel(reservation.status) }}
            </span>
          </div>

          <div class="reservation-details">
            <div class="detail-row">
              <span class="detail-label">Reservation ID:</span>
              <span class="detail-value reservation-id"
                >{{ reservation.reservationId.substring(0, 8) }}...</span
              >
            </div>
            <div class="detail-row">
              <span class="detail-label">Guests:</span>
              <span class="detail-value">{{ reservation.guestCount }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Total Amount:</span>
              <span class="detail-value amount">{{
                formatCurrency(reservation.totalAmount, reservation.currency)
              }}</span>
            </div>
            @if (reservation.specialRequests) {
            <div class="detail-row">
              <span class="detail-label">Special Requests:</span>
              <span class="detail-value">{{ reservation.specialRequests }}</span>
            </div>
            }
          </div>

          <div class="reservation-actions">
            @if (hasBalance(reservation)) {
            <button class="btn btn-primary" type="button" (click)="payReservation(reservation)">
              Pay {{ formatCurrency(reservation.totalAmount, reservation.currency) }}
            </button>
            } @if (canModify(reservation)) {
            <button class="btn btn-secondary" type="button" (click)="openModifyModal(reservation)">
              Modify
            </button>
            } @if (canCancel(reservation)) {
            <button class="btn btn-danger" type="button" (click)="openCancelModal(reservation)">
              Cancel
            </button>
            }
          </div>
        </div>
        }
      </div>
      }
    </section>
    } }
  </div>
</main>

@if (showModifyModal && selectedReservation) {
<app-reservation-modify-modal
  [reservation]="selectedReservation"
  (close)="closeModifyModal()"
  (updated)="onReservationUpdated($event)"
></app-reservation-modify-modal>
} @if (showCancelModal && selectedReservation) {
<app-reservation-cancel-modal
  [reservation]="selectedReservation"
  (close)="closeCancelModal()"
  (cancelled)="onReservationCancelled($event)"
></app-reservation-cancel-modal>
}
