name: Deploy Backend (Spring Boot) to Elastic Beanstalk

on:
  push:
    branches: ["main"]
    paths:
      - "backend/reserveone/**"
      - ".github/workflows/deploy-eb-backend.yml"
  workflow_dispatch:

concurrency:
  group: eb-backend-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  EB_APPLICATION_NAME: reserveone
  EB_ENVIRONMENT_NAME: Reserveone-env
  BACKEND_DIR: backend/reserveone
  # EB is happiest when the bundle contains a root-level "application.jar"
  EB_JAR_NAME: application.jar

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: maven

      # jq is usually present on ubuntu-latest, but installing it makes the workflow resilient.
      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_GHA_OIDC_ROLE_ARN }}
          role-session-name: gha-eb-deploy
          mask-aws-account-id: true
          unset-current-credentials: true

      - name: Debug AWS identity
        run: |
          set -euo pipefail
          aws sts get-caller-identity --output json
          ARN="$(aws sts get-caller-identity --query Arn --output text)"
          echo "Assumed role/session: $(echo "$ARN" | awk -F'/' '{print $(NF-1) "/" $NF}')"

      - name: Build JAR (Maven)
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          set -euo pipefail
          mvn -B -DskipTests package

      - name: Prepare Elastic Beanstalk source bundle (zip)
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          set -euo pipefail

          echo "Built artifacts:"
          ls -lh target || true
          echo

          # Pick the newest runnable jar (exclude *original*, sources, javadoc, tests)
          JAR_PATH="$(ls -1t target/*.jar | grep -vE '(original|sources|javadoc|tests)' | head -n 1 || true)"
          if [ -z "${JAR_PATH}" ]; then
            echo "No deployable JAR found in target/." >&2
            exit 1
          fi

          echo "Using jar: ${JAR_PATH}"
          sha256sum "${JAR_PATH}" || true

          # EB needs config dirs shipped inside the source bundle
          for required_dir in .ebextensions .platform; do
            if [ ! -d "${required_dir}" ]; then
              echo "Missing required directory '${required_dir}' in ${PWD}." >&2
              exit 1
            fi
          done

          rm -rf eb-bundle bundle.zip
          mkdir -p eb-bundle

          # EB expects the runnable jar at bundle root.
          # Name it application.jar so Procfile is stable.
          cp "${JAR_PATH}" "eb-bundle/application.jar"

          cp -R .platform eb-bundle/.platform
          cp -R .ebextensions eb-bundle/.ebextensions

          # Ensure Procfile exists (no heredoc)
          if [ -f "Procfile" ]; then
            cp Procfile eb-bundle/Procfile
          else
            printf "%s\n" "web: java -jar application.jar" > eb-bundle/Procfile
          fi

          (cd eb-bundle && zip -qr ../bundle.zip .)

          echo
          echo "Bundle contents (first 120 lines):"
          unzip -l bundle.zip | head -n 120

          echo
          echo "Sanity check: application.jar and Procfile are at bundle root"
          unzip -l bundle.zip | awk '{print $4}' | grep -qx "application.jar" \
            || { echo "ERROR: application.jar missing at bundle root"; exit 1; }
          unzip -l bundle.zip | awk '{print $4}' | grep -qx "Procfile" \
            || { echo "ERROR: Procfile missing at bundle root"; exit 1; }
